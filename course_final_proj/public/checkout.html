<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" type="image/x-icon" href="./images/projfavicon.png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <style>
        @media (min-width: 768px) {
            .card-body {
                position: fixed;
                right: 20px;
                top: 100px;
                width: 300px;
            }
        }

        .price-line {
            display: flex;
            justify-content: space-between;
        }

        .price-line p {
            margin-bottom: 0;
        }

        .btn-confirm {
            background-color: #f87171;
            border-color: #f87171;
        }

        .btn-confirm:hover {
            background-color: #f03e3e;
            border-color: #f03e3e;
        }

        .btn-confirm:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.5);
        }
    </style>
</head>

<body>
    <header>
        <div class="grid grid-cols-3 px-16 items-center w-screen h-20 border-b-[1px]">
            <a href="index.html" class="flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
                    <path
                        d="M19.006 3.705a.75.75 0 1 0-.512-1.41L6 6.838V3a.75.75 0 0 0-.75-.75h-1.5A.75.75 0 0 0 3 3v4.93l-1.006.365a.75.75 0 0 0 .512 1.41l16.5-6Z" />
                    <path fill-rule="evenodd"
                        d="M3.019 11.114 18 5.667v3.421l4.006 1.457a.75.75 0 1 1-.512 1.41l-.494-.18v8.475h.75a.75.75 0 0 1 0 1.5H2.25a.75.75 0 0 1 0-1.5H3v-9.129l.019-.007ZM18 20.25v-9.566l1.5.546v9.02H18Zm-9-6a.75.75 0 0 0-.75.75v4.5c0 .414.336.75.75.75h3a.75.75 0 0 0 .75-.75V15a.75.75 0 0 0-.75-.75H9Z"
                        clip-rule="evenodd" />
                </svg>
                <span class="font-bold text-xl">Airdnd</span>
            </a>
            <div class="flex justify-evenly items-center rounded-full h-12 w-96 ">
                <button class="border-r-2 text-sm font-medium px-4"></button>
                <button class="border-r-2 text-sm font-medium px-4"></button>
                <button class="text-sm font-medium text-white px-2"></button>
                <i class="fa-solid fa-magnifying-glass bg-white text-white rounded-full p-2"></i>
            </div>
            <div class="flex justify-end items-center gap-8">
                <button class="text-sm font-medium">Airdnd your home</button>
                <span class="material-symbols-outlined">language</span>
                <div class="flex justify-evenly items-center gap-2 rounded-full border shadow-md h-10 w-20">
                    <i class="fa-solid fa-bars"></i>
                    <button class="bg-black text-white rounded-full text-center w-7 h-7 text-[10px]"><i
                            class="fa-solid fa-user"></i></button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mt-5">
        <div class="row">
            <!-- payment info-->
            <div class="col-md-6">
                <h2 class="text-xl font-bold mb-4">Booking Confirmation</h2>
                <p style="display: block; margin-bottom: 10px;">
                    <strong>Dates:</strong> <br>
                    <span class="checkIn">TESTING</span>
                    <br>
                    <span class="checkOut">TESTING</span>
                </p>
                <p style="display: block; margin-bottom: 10px;">
                    <strong>Guests:</strong> <br>
                    <span class="guests">TESTING</span>
                </p>

                <label for="paymentMethod" class="block text-md font-bold mt-3 mb-2">Pay with</label>
                <select id="paymentMethod" class="form-control">
                    <option value="card">Credit or debit card</option>
                    <option value="paypal">PayPal</option>
                    <option value="googlepay">Google Pay</option>
                </select>

                <label for="cardNumber" class="block text-sm font-semibold mt-3">Card Number</label>
                <input type="text" id="cardNumber" class="form-control" placeholder="Card Number">

                <div class="form-row mt-3">
                    <div class="col">
                        <label for="expDate" class="block text-sm font-semibold">Expiration Date</label>
                        <input type="text" id="expDate" class="form-control" placeholder="MM/YY">
                    </div>
                    <div class="col mt-3">
                        <label for="cvv" class="block text-sm font-semibold">CVV</label>
                        <input type="text" id="cvv" class="form-control" placeholder="CVV">
                    </div>
                </div>

                <label for="zipCode" class="block text-sm font-semibold mt-3">Zip Code</label>
                <input type="text" id="zipCode" class="form-control" placeholder="Zip Code">

                <label for="country" class="block text-sm font-semibold mt-3">Country/Region</label>
                <select id="country" class="form-control">
                    <option value="us">United States</option>
                    <option value="canada">Canada</option>
                    <option value="mexico">Mexico</option>
                </select>

                <button class="btn btn-primary btn-confirm w-full mt-3 mb-5" onclick="confirmAndPay()">Confirm
                    and Pay</button>

            </div>

            <!-- listing details and pricing -->
            <div class="col-md-6">
                <div class="card card-body bg-white p-4 rounded-lg shadow-sm"
                    style="position: fixed; right: 100px; top: 200px; width: 500px;">
                    <div class="d-flex align-items-center mb-4">
                        <p style="display: block; margin-bottom: 10px;">
                            <strong class="title">TESTING</strong> <br>
                            <span class="propType">TESTING</span>
                        </p>
                    </div>
                    <div>
                        <h2 class="font-bold mb-2">Price details</h2>
                        <div class="price-line">
                            <p class="pricing">TESTING</p>
                            <p class="totalPrice">TESTING</p>
                        </div>
                        <div class="price-line">
                            <p>Cleaning fee</p>
                            <p class="cleaningFee">TESTING</p>
                        </div>
                        <div class="price-line font-bold">
                            <p>Total (USD)</p>
                            <p class="grandTotal">TESTING</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const checkIn = urlParams.get('checkIn');
            const checkOut = urlParams.get('checkOut');
            const guests = urlParams.get('guests');
            const pricing = parseFloat(urlParams.get('pricing'));
            const title = urlParams.get('title');
            const cleaningFee = parseFloat(urlParams.get('cleaningFee'));
            const propType = urlParams.get('propType');

            // if any of the parameters are missing return an error
            if (!checkIn || !checkOut || !guests || !pricing) {
                console.error("Parameters are missing");
                return;
            }

            document.querySelector('.checkIn').textContent = `Check-in: ${checkIn}`;
            document.querySelector('.checkOut').textContent = `Check-out: ${checkOut}`;
            document.querySelector('.guests').textContent = guests;
            document.querySelector('.title').textContent = title;
            document.querySelector('.propType').textContent = propType;
            document.querySelector('.cleaningFee').textContent = `$${cleaningFee.toFixed(2)}`;


            // calculate pricing using checkin checkout dates
            const date1 = new Date(checkIn);
            const date2 = new Date(checkOut);
            const diffTime = Math.abs(date2 - date1);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const totalPrice = diffDays * parseFloat(pricing);
            const grandTotal = totalPrice + cleaningFee;

            document.querySelector('.pricing').textContent = `$${pricing} x ${diffDays} nights`;
            document.querySelector('.totalPrice').textContent = `$${totalPrice.toFixed(2)}`;
            document.querySelector('.grandTotal').textContent = `$${grandTotal.toFixed(2)}`;

            const listingID = urlParams.get('listingID');

        });
    </script>

    <!-- email confirmation -->
    <script type="text/javascript" src="https://cdn.emailjs.com/sdk/2.3.2/email.min.js"></script>
    <script type="text/javascript">
        (function () {
            emailjs.init("YlyQV5lRj0piMTJ3Z");
        })();
    </script>

    <script type="text/javascript">
        function confirmAndPay() {
            getLastGuestAndCreateBooking();
        }

        function getLastGuestAndCreateBooking() {
            fetch('/api/lastguest')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const guestID = data.guestID;
                        createBooking(guestID);
                    } else {
                        throw new Error('No guest ID returned');
                    }
                })
                .catch(error => {
                    console.error('Failed to retrieve last guest:', error);
                    alert('Failed to retrieve last guest');
                });
        }

        function createBooking(guestID) {
            const listingID = new URLSearchParams(window.location.search).get('listingID');
            const startDate = new URLSearchParams(window.location.search).get('checkIn');
            const endDate = new URLSearchParams(window.location.search).get('checkOut');

            fetch('/api/bookings/addBooking', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    startDate: startDate,
                    endDate: endDate,
                    guestID: guestID,
                    listingID: listingID
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Booking added successfully');
                        sendConfirmationEmail();
                    } else {
                        throw new Error('Booking failed');
                    }
                })
                .catch(error => {
                    console.error('Failed to add booking:', error);
                    alert('Failed to add booking');
                });
        }

        function sendConfirmationEmail() {
            emailjs.send("service_7wp1hpz", "template_dnd1chg", {
                to_name: "darzhu51423@gmail.com",
                message: "Airdnd confirms your booking"
            })
                .then(function (response) {
                    console.log('Email SUCCESS!', response.status, response.text);
                    alert('Email sent successfully');
                    window.location.href = 'index.html';
                }, function (error) {
                    console.error('Email FAILED...', error);
                    alert('Failed to send email: ' + error.text);
                });
        }
    </script>
</body>


</html>